using Dapper; using BookStoreApi.Data; using BookStoreApi.Models; namespace BookStoreApi.Repositories; public class AuthorRepository : IAuthorRepository { private readonly DapperContext _context; public AuthorRepository(DapperContext context) { _context = context; } public async Task<Author> CreateAsync(Author author) { using var conn = _context.CreateConnection(); var id = await conn.ExecuteScalarAsync<int>("INSERT INTO authors(name,bio) VALUES(@Name,@Bio) RETURNING id", author); author.Id = id; return author; } public async Task DeleteAsync(int id) { using var conn = _context.CreateConnection(); await conn.ExecuteAsync("DELETE FROM authors WHERE id=@Id", new { Id = id }); } public async Task<IEnumerable<Author>> GetAllAsync() { using var conn = _context.CreateConnection(); return await conn.QueryAsync<Author>("SELECT * FROM authors ORDER BY id"); } public async Task<Author?> GetByIdAsync(int id) { using var conn = _context.CreateConnection(); return await conn.QueryFirstOrDefaultAsync<Author>("SELECT * FROM authors WHERE id=@Id", new { Id = id }); } public async Task<Author?> ReplaceAsync(int id, Author author) { using var conn = _context.CreateConnection(); author.Id = id; await conn.ExecuteAsync("UPDATE authors SET name=@Name, bio=@Bio WHERE id=@Id", author); return await GetByIdAsync(id); } public async Task<Author?> UpdateAsync(int id, object partial) { var kv = new Dictionary<string, object?>(); foreach (var prop in partial.GetType().GetProperties()) kv[prop.Name] = prop.GetValue(partial); if (!kv.Any()) return await GetByIdAsync(id); var set = string.Join(",", kv.Keys.Select((k,i)=>$"{k}=@p{i}")); var parameters = new DynamicParameters(); int idx=0; foreach(var v in kv.Values){ parameters.Add($"p{idx}", v); idx++; } parameters.Add("Id", id); using var conn = _context.CreateConnection(); await conn.ExecuteAsync($"UPDATE authors SET {set} WHERE id=@Id", parameters); return await GetByIdAsync(id); } }
