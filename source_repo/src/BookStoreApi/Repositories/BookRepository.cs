using Dapper; using BookStoreApi.Data; using BookStoreApi.Models; namespace BookStoreApi.Repositories; public class BookRepository : IBookRepository { private readonly DapperContext _context; public BookRepository(DapperContext context) { _context = context; } public async Task<Book> CreateAsync(Book book) { using var conn = _context.CreateConnection(); var id = await conn.ExecuteScalarAsync<int>("INSERT INTO books(title, author_id, isbn, price, published_date) VALUES(@Title,@AuthorId,@Isbn,@Price,@PublishedDate) RETURNING id", book); book.Id = id; return book; } public async Task DeleteAsync(int id) { using var conn = _context.CreateConnection(); await conn.ExecuteAsync("DELETE FROM books WHERE id=@Id", new { Id = id }); } public async Task<IEnumerable<Book>> GetAllAsync() { using var conn = _context.CreateConnection(); return await conn.QueryAsync<Book>("SELECT * FROM books ORDER BY id"); } public async Task<Book?> GetByIdAsync(int id) { using var conn = _context.CreateConnection(); return await conn.QueryFirstOrDefaultAsync<Book>("SELECT * FROM books WHERE id=@Id", new { Id = id }); } public async Task<Book?> ReplaceAsync(int id, Book book) { using var conn = _context.CreateConnection(); book.Id = id; await conn.ExecuteAsync("UPDATE books SET title=@Title, author_id=@AuthorId, isbn=@Isbn, price=@Price, published_date=@PublishedDate WHERE id=@Id", book); return await GetByIdAsync(id); } public async Task<Book?> UpdateAsync(int id, object partial) { var kv = new Dictionary<string, object?>(); foreach (var prop in partial.GetType().GetProperties()) kv[prop.Name] = prop.GetValue(partial); if (!kv.Any()) return await GetByIdAsync(id); var set = string.Join(",", kv.Keys.Select((k,i)=>$"{k}=@p{i}")); var parameters = new DynamicParameters(); int idx=0; foreach(var v in kv.Values){ parameters.Add($"p{idx}", v); idx++; } parameters.Add("Id", id); using var conn = _context.CreateConnection(); await conn.ExecuteAsync($"UPDATE books SET {set} WHERE id=@Id", parameters); return await GetByIdAsync(id); } }
