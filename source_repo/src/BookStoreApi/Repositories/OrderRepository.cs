using Dapper; using BookStoreApi.Data; using BookStoreApi.Models; namespace BookStoreApi.Repositories; public class OrderRepository : IOrderRepository { private readonly DapperContext _context; public OrderRepository(DapperContext context) { _context = context; } public async Task<Order> CreateAsync(Order order) { using var conn = _context.CreateConnection(); var id = await conn.ExecuteScalarAsync<int>("INSERT INTO orders(book_id,quantity,total_price,customer_name) VALUES(@BookId,@Quantity,@TotalPrice,@CustomerName) RETURNING id", order); order.Id = id; return order; } public async Task DeleteAsync(int id) { using var conn = _context.CreateConnection(); await conn.ExecuteAsync("DELETE FROM orders WHERE id=@Id", new { Id = id }); } public async Task<IEnumerable<Order>> GetAllAsync() { using var conn = _context.CreateConnection(); return await conn.QueryAsync<Order>("SELECT * FROM orders ORDER BY id"); } public async Task<Order?> GetByIdAsync(int id) { using var conn = _context.CreateConnection(); return await conn.QueryFirstOrDefaultAsync<Order>("SELECT * FROM orders WHERE id=@Id", new { Id = id }); } public async Task<Order?> ReplaceAsync(int id, Order order) { using var conn = _context.CreateConnection(); order.Id = id; await conn.ExecuteAsync("UPDATE orders SET book_id=@BookId, quantity=@Quantity, total_price=@TotalPrice, customer_name=@CustomerName WHERE id=@Id", order); return await GetByIdAsync(id); } public async Task<Order?> UpdateAsync(int id, object partial) { var kv = new Dictionary<string, object?>(); foreach (var prop in partial.GetType().GetProperties()) kv[prop.Name] = prop.GetValue(partial); if (!kv.Any()) return await GetByIdAsync(id); var set = string.Join(",", kv.Keys.Select((k,i)=>$"{k}=@p{i}")); var parameters = new DynamicParameters(); int idx=0; foreach(var v in kv.Values){ parameters.Add($"p{idx}", v); idx++; } parameters.Add("Id", id); using var conn = _context.CreateConnection(); await conn.ExecuteAsync($"UPDATE orders SET {set} WHERE id=@Id", parameters); return await GetByIdAsync(id); } }
